<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RUBYRED GARMENT - ERP SYSTEM</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
<link rel="icon" href="pic/logooo.png">
<style>
    :root {
        --bg:#0b0f19; --card:#161b26; --text:#f1f5f9;
        --border:#2d3748; --orange:#f59e0b; --red:#ff4d4d; --green:#10b981; --yellow:#eab308; --muted:#9ca3af;
    }
    * { box-sizing:border-box; margin:0; padding:0; font-family: 'Cairo', sans-serif; }
    body { background:var(--bg); color:var(--text); padding: 20px; direction: ltr; }

    header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 20px; 
        border-bottom: 1px solid var(--border); 
        padding-bottom: 15px;
    }

    .company-side { flex: 1; display: flex; justify-content: flex-start; }
    .logo-side { flex: 1; display: flex; justify-content: center; }
    .actions-side { flex: 1; display: flex; justify-content: flex-end; gap: 10px; }

    .logo-text { font-size: 1.5rem; font-weight: 900; color: white; letter-spacing: -1px; white-space: nowrap; }
    .logo-text span { color: var(--red); }

    .rotating-logo { width: 60px; height: 60px; border-radius: 50%; animation: rotate 10s linear infinite; }

    #btnBack { 
        background: var(--card); color: white; border: 1px solid var(--border); 
        padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 700; 
        display: flex; align-items: center; gap: 5px; height: 45px;
    }
    #btnBack:hover { border-color: var(--orange); }

    .lang-select { background: var(--card); color: white; border: 1px solid var(--border); padding: 8px; border-radius: 8px; cursor: pointer; font-weight: 700; height: 45px; }

    /* دعم اللغة العربية */
    .rtl { direction: rtl; }
    .rtl .company-side { justify-content: flex-start; }
    .rtl .actions-side { justify-content: flex-end; } 
    
    .section-title { font-size: 1.1rem; font-weight: 800; color: var(--muted); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; text-transform: uppercase; }
    .section-title::after { content: ""; flex: 1; height: 1px; background: var(--border); }

    .inventory-header { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 40px; }
    .inv-card { background: var(--card); padding: 20px; border-radius: 15px; border-bottom: 6px solid var(--green); text-align: center; }
    .inv-card.warning { border-bottom-color: var(--yellow); }
    .inv-card.danger { border-bottom-color: var(--red); animation: blink 1.5s infinite; }
    
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
    .line-card { background: var(--card); border-radius: 20px; padding: 20px; border: 1px solid var(--border); }
    .line-header { font-size: 1.4rem; font-weight: 900; color: var(--orange); border-bottom: 1px solid var(--border); margin-bottom: 12px; }
    .res-row { padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .res-info { display: flex; justify-content: space-between; }
    .deficit-msg { color: var(--red); font-size: 0.75rem; font-weight: 700; display: block; margin-top: 5px; border-left: 2px solid var(--red); padding-left: 8px; }
    .rtl .deficit-msg { border-left: 0; border-right: 2px solid var(--red); padding-right: 8px; }

    @media (max-width: 650px) {
        header { flex-direction: column; gap: 15px; }
        .company-side, .logo-side, .actions-side { justify-content: center; width: 100%; }
    }
</style>
</head>
<body>

    <header>
        <div class="company-side">
            <div class="logo-text">RUBY<span>RED</span> GARMENT</div>
        </div>
        
        <div class="logo-side">
            <img src="pic/logooo.png" alt="Logo" class="rotating-logo" onerror="this.src='https://via.placeholder.com/60/d80f0f/ffffff?text=R'">
        </div>
        
        <div class="actions-side">
            <button onclick="window.location.href='index.html'" id="btnBack">
                <span id="backArrow">⬅</span> <span id="backText">Back</span>
            </button>
            <select class="lang-select" id="langSwitcher" onchange="changeLanguage()">
                <option value="en">English</option>
                <option value="ar">العربية</option>
                <option value="tr">Türkçe</option>
            </select>
        </div>
    </header>

    <div class="section-title" id="titleStock">Total Materials Stock</div>
    <div class="inventory-header" id="dynamicInventory"></div>

    <div class="section-title" id="titleLines">Production Lines Allocation</div>
    <div class="grid" id="linesGrid"></div>

<script>
const SHEET_ID = "1cENOlMaEm3rXxzxGB40t42eWiJKa7zZy22B2l5nWVa0";
let currentLang = 'en';

const dictionary = {
    back: { en: "Back", ar: "رجوع", tr: "Geri" },
    stock: { en: "Total Materials Stock", ar: "رصيد المخزن الكلي", tr: "Toplam Malzeme Stoğu" },
    lines: { en: "Production Lines Allocation", ar: "توزيع خطوط الإنتاج", tr: "Üretim Hattı Tahsisi" },
    line: { en: "Line", ar: "خط", tr: "Hat" },
    wait: { en: "Waiting for allocation...", ar: "في انتظار التوزيع...", tr: "Tahsis bekleniyor..." },
    initial: { en: "Initial", ar: "الأولي", tr: "Başlangıç" },
    deficit: { en: "deficit not added due to out of stock", ar: "عجز لم يتم إضافته لنفاد الكمية", tr: "stok yetersizliği nedeniyle eklenmedi" },
    fabric: { en: "Fabric", ar: "قماش", tr: "Kumaş" },
    lining: { en: "Lining", ar: "بطانة", tr: "Astar" },
    interlining: { en: "Interlining", ar: "حشو", tr: "Tela" },
    rib: { en: "Rib", ar: "ريب", tr: "Riba" },
    thread: { en: "Thread", ar: "خيط", tr: "İplik" },
    zipper: { en: "Zipper", ar: "سوستة", tr: "Fermuar" }, // تم تصحيح الترجمة هنا
    button: { en: "Buttons", ar: "زراير", tr: "Düğme" },
    elastic: { en: "Elastic", ar: "أستك", tr: "Lastik" },
    label: { en: "Label", ar: "ماركة", tr: "Etiket" },
    polybag: { en: "Polybag", ar: "كيس تغليف", tr: "Naylon Torba" }
};

function t(word) {
    const key = word.toLowerCase().trim();
    return (dictionary[key] && dictionary[key][currentLang]) ? dictionary[key][currentLang] : word;
}

async function fetchData() {
    try {
        const resTotal = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Total+material`);
        const textTotal = await resTotal.text();
        const totalRows = textTotal.split("\n").map(r => r.split('","').map(c => c.replace(/"/g, '').trim()));
        let stockInitial = {}; 
        if (totalRows.length >= 2) {
            totalRows[0].forEach((m, i) => {
                if(m) {
                    let val = totalRows[1][i] ? totalRows[1][i].toString().replace(/[^0-9.]/g, '') : "0";
                    stockInitial[m.trim()] = parseFloat(val) || 0;
                }
            });
        }
        const resAlloc = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Allocation`);
        const textAlloc = await resAlloc.text();
        const allocRows = textAlloc.split("\n").map(r => r.split('","').map(c => c.replace(/"/g, '').trim()));
        const headers = allocRows[0].map(h => h.trim());
        const allocations = allocRows.slice(1).map(row => {
            let obj = {}; headers.forEach((h, i) => obj[h] = row[i]); return obj;
        });
        calculateAndRender(stockInitial, allocations);
    } catch (e) { console.error("Sync Error:", e); }
}

function calculateAndRender(initialStock, allocations) {
    let lineData = {};
    let runningConsumption = {};
    allocations.forEach(item => {
        const line = item.Line ? item.Line.trim() : null;
        const mat = item.Material ? item.Material.trim() : null;
        let qtyReq = parseFloat(item.Qty ? item.Qty.toString().replace(/[^0-9.]/g, '') : "0") || 0;
        if (line && mat) {
            if (!lineData[line]) lineData[line] = [];
            let consumed = runningConsumption[mat] || 0;
            let available = initialStock[mat] - consumed;
            let actual = qtyReq > available ? (available > 0 ? available : 0) : qtyReq;
            let deficit = qtyReq - actual;
            lineData[line].push({ mat, qty: actual, deficit: deficit });
            runningConsumption[mat] = (runningConsumption[mat] || 0) + actual;
        }
    });
    const invHeader = document.getElementById('dynamicInventory');
    invHeader.innerHTML = "";
    Object.keys(initialStock).forEach(mat => {
        const rem = initialStock[mat] - (runningConsumption[mat] || 0);
        const percent = (rem / initialStock[mat]) * 100;
        let statusClass = "";
        let percentColor = "var(--green)";
        if (percent <= 25) { statusClass = "danger"; percentColor = "var(--red)"; }
        else if (percent <= 75) { statusClass = "warning"; percentColor = "var(--yellow)"; }
        invHeader.innerHTML += `<div class="inv-card ${statusClass}"><h3>${t(mat)}</h3><div class="value">${rem.toLocaleString()}</div><div class="percentage" style="color:${percentColor}">${percent.toFixed(1)}%</div><span style="font-size:0.65rem; color:var(--muted)">${t('initial')}: ${initialStock[mat]}</span></div>`;
    });
    const grid = document.getElementById('linesGrid');
    grid.innerHTML = "";
    for (let i = 1; i <= 30; i++) {
        const lineKey = "Line " + i;
        const card = document.createElement('div');
        card.className = 'line-card';
        let content = "";
        if (lineData[lineKey]) {
            lineData[lineKey].forEach(d => {
                content += `<div class="res-row"><div class="res-info"><span>${t(d.mat)}:</span><b>${d.qty.toLocaleString()}</b></div>${d.deficit > 0 ? `<span class="deficit-msg">⚠️ ${d.deficit.toLocaleString()} ${t('deficit')}</span>` : ''}</div>`;
            });
        } else { content = `<div class="waiting">${t('wait')}</div>`; }
        card.innerHTML = `<div class="line-header">${t('line')} ${i}</div>${content}`;
        grid.appendChild(card);
    }
}

function changeLanguage() {
    currentLang = document.getElementById('langSwitcher').value;
    document.body.className = currentLang === 'ar' ? 'rtl' : '';
    document.getElementById('titleStock').innerText = t('stock');
    document.getElementById('titleLines').innerText = t('lines');
    document.getElementById('backText').innerText = t('back');
    document.getElementById('backArrow').innerText = currentLang === 'ar' ? '➡' : '⬅';
    fetchData();
}

fetchData();
setInterval(fetchData, 15000);
</script>
</body>
</html>